<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æœºä¼šè¯¦æƒ… - AIé¢è¯•åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="dialog.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .prose h1 { font-size: 1.5rem; } .prose h2 { font-size: 1.25rem; } .prose h3 { font-size: 1.1rem; }
        .prose p { margin-bottom: 1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .secondary-tab.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="pb-20">
    <!-- Header -->
    <div class="bg-white shadow-sm pb-4">
        <div class="container mx-auto p-4">
            <!-- <a href="opportunities.html" class="text-blue-600 text-sm mb-2 block">&larr; è¿”å›åˆ—è¡¨</a> -->
            <h1 id="opportunity-title" class="text-2xl font-bold text-gray-800"></h1>
            <p id="opportunity-company" class="text-gray-500"></p>
        </div>
    </div>

    <!-- Main AI Actions -->
    <div class="container mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="w-full bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-l-4 border-blue-500">
                 <button id="main-action-resume" class="w-full text-left">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">âœ¨</div>
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">AI ç”Ÿæˆå®šåˆ¶ç®€å†</h2>
                            <p class="text-sm text-gray-500 mt-1">æ ¹æ®JDå’Œä½ çš„èƒŒæ™¯ï¼Œé‡èº«æ‰“é€ ç®€å†</p>
                        </div>
                    </div>
                </button>
            </div>
            <div id="practice-action-container" class="w-full bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                <div id="practice-initial-btn">
                    <button id="main-action-practice" class="w-full text-left">
                        <div class="flex items-center">
                            <div class="text-3xl mr-4">ğŸ™ï¸</div>
                            <div>
                                <h2 class="font-bold text-lg text-gray-800">AI è¿›è¡Œé¢è¯•æ¼”ç»ƒ</h2>
                                <p class="text-sm text-gray-500 mt-1">æ¨¡æ‹Ÿå®æˆ˜ï¼Œé¢„æµ‹é—®é¢˜å¹¶ç»ƒä¹ å›ç­”</p>
                            </div>
                        </div>
                    </button>
                </div>
                <div id="practice-loading-state" class="hidden">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4 animate-spin"><i class="fas fa-spinner"></i></div>
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">AI æ­£åœ¨ç”Ÿæˆé—®é¢˜...</h2>
                            <p class="text-sm text-gray-500 mt-1">è¯·ç¨å€™ï¼Œæ­£åœ¨åˆ†æJDå’Œç®€å†</p>
                        </div>
                    </div>
                </div>
                <div id="practice-confirm-state" class="hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="font-bold text-lg text-green-600">AI å·²ä¸ºæ‚¨ç”Ÿæˆ 3 ä¸ªé«˜é¢‘é—®é¢˜ï¼</h2>
                            <p class="text-sm text-gray-500 mt-1">å‡†å¤‡å¥½æŒ‘æˆ˜äº†å—ï¼Ÿ</p>
                        </div>
                        <button id="start-practice-btn" class="bg-purple-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-purple-700">ç«‹å³å¼€å§‹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Content (Details) -->
    <div class="container mx-auto p-4">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="secondary-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="details">èŒä½è¯¦æƒ…</button>
                <button class="secondary-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="resume">ç®€å†è¯¦æƒ…</button>
                <button class="secondary-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="qa">é—®ç­”è¯¦æƒ…</button>
                <button class="secondary-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="report">è¯„ä¼°æŠ¥å‘Š</button>
            </nav>
        </div>
        <div class="mt-4 bg-white p-4 rounded-xl shadow-sm min-h-[400px]">
            <div id="tab-details" class="tab-content space-y-4">
                <h3 class="font-bold text-gray-700 mb-2">å²—ä½æè¿° (JD)</h3>
                <p id="opportunity-jd" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line"></p>
                <button id="analyze-jd-btn" class="mt-4 bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-md hover:bg-blue-600"><i class="fas fa-brain mr-2"></i>AIåˆ†æJD</button>

                <div id="jd-analysis-results" class="mt-6 hidden">
                    <div id="jd-keywords-analysis" class="bg-blue-50 p-4 rounded-lg shadow-sm mb-4">
                        <h4 class="font-bold text-blue-800 mb-2">æ ¸å¿ƒå…³é”®è¯</h4>
                        <div id="keywords-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="resume-pre-match-analysis" class="bg-green-50 p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold text-green-800 mb-2">ç®€å†é¢„åŒ¹é…åˆ†æ</h4>
                        <p id="pre-match-text" class="text-sm text-green-700"></p>
                    </div>
                </div>
            </div>
            <div id="tab-resume" class="tab-content hidden">
                <div id="resume-placeholder">
                    <p class="text-gray-400 p-4 text-center">å°šæœªç”Ÿæˆç®€å†ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹çš„â€œAIç”Ÿæˆå®šåˆ¶ç®€å†â€æŒ‰é’®å¼€å§‹ã€‚</p>
                </div>
                <div id="resume-content-container" class="hidden">
                    <div id="resume-display-mode">
                        <div class="flex justify-end mb-2 space-x-2">
                            <button id="resume-download-btn" class="bg-blue-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-blue-600">ä¸‹è½½PDF</button>
                            <button id="resume-edit-btn" class="bg-gray-200 text-sm font-semibold py-1 px-3 rounded-md hover:bg-gray-300">ç¼–è¾‘</button>
                        </div>
                        <div id="resume-preview-area" class="prose p-4 border rounded bg-gray-50 min-h-[200px]"></div>
                    </div>
                    <div id="resume-edit-mode" class="hidden">
                        <textarea id="resume-editor" class="w-full p-2 border rounded" rows="20"></textarea>
                        <div class="mt-2 flex justify-end space-x-2">
                            <button id="resume-cancel-btn" class="bg-gray-500 text-white text-sm py-1 px-3 rounded-md">å–æ¶ˆ</button>
                            <button id="resume-save-btn" class="bg-green-600 text-white text-sm py-1 px-3 rounded-md">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-qa" class="tab-content hidden">
                <div id="qa-controls" class="hidden flex justify-end space-x-2 mb-4">
                    <button id="add-qa-btn" class="bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-600">+ æ–°å¢é—®ç­”</button>
                    <button id="save-qa-btn" class="bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-green-700">ä¿å­˜å…¨éƒ¨ä¿®æ”¹</button>
                </div>
                <p id="qa-placeholder" class="text-gray-400 p-4 text-center">å°šæœªç”Ÿæˆé—®ç­”ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹çš„â€œAIè¿›è¡Œé¢è¯•æ¼”ç»ƒâ€æŒ‰é’®å¼€å§‹ã€‚</p>
                <div id="qa-list-container" class="space-y-4"></div>
            </div>
            <div id="tab-report" class="tab-content hidden">
                <div id="report-placeholder">
                    <p class="text-gray-400 p-4 text-center">å°šæœªè¿›è¡Œé¢è¯•æ¼”ç»ƒï¼Œæš‚æ— è¯„ä¼°æŠ¥å‘Šã€‚</p>
                </div>
                <div id="report-content-container" class="hidden space-y-6">
                    <!-- Overall Score -->
                    <div class="text-center">
                        <p class="text-sm text-gray-500">ç»¼åˆè¯„åˆ†</p>
                        <p id="report-score" class="text-6xl font-bold text-blue-600"></p>
                    </div>
                    <!-- Bar Chart -->
                    <div id="report-bar-chart" class="space-y-3 my-6">
                        <!-- Skill Item 1 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">æ²Ÿé€šèƒ½åŠ›</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 85%;">85</div>
                            </div>
                        </div>
                        <!-- Skill Item 2 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">æŠ€æœ¯æ·±åº¦</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 90%;">90</div>
                            </div>
                        </div>
                        <!-- Skill Item 3 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">é€»è¾‘æ€ç»´</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 80%;">80</div>
                            </div>
                        </div>
                        <!-- Skill Item 4 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">STARåŸåˆ™</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 75%;">75</div>
                            </div>
                        </div>
                    </div>
                    <!-- Overall Feedback -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">æ•´ä½“è¯„ä»·</h3>
                        <p id="report-feedback" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg"></p>
                    </div>
                     <!-- Session Details -->
                    <div id="report-session-details-container" class="hidden">
                        <h3 class="font-bold text-gray-700 mb-2">ä¼šè¯è¯¦æƒ…</h3>
                        <div id="report-session-details" class="space-y-3"></div>
                    </div>
                    <!-- History -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">å†å²è®°å½•</h3>
                        <div id="report-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS AND OVERLAYS -->
    <div id="keyword-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-auto p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">å…³é”®è¯å¼•å¯¼</h3>
            <p class="text-sm text-gray-500 mb-4">è¾“å…¥å¸Œæœ›AIé‡ç‚¹çªå‡ºçš„å…³é”®è¯ï¼ˆå¯é€‰ï¼‰</p>
            <input type="text" id="resume-keywords" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ä¾‹å¦‚: Vue3, å›¢é˜Ÿåˆä½œ">
            <div class="mt-5 flex justify-end space-x-3">
                <button id="cancel-keyword-btn" class="px-4 py-2 bg-gray-200 rounded-md text-sm font-medium">å–æ¶ˆ</button>
                <button id="generate-with-keyword-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium">ç¡®è®¤ç”Ÿæˆ</button>
            </div>
        </div>
    </div>
    <div id="practice-overlay" class="hidden fixed inset-0 bg-gray-800 z-50 p-6 flex flex-col text-white">
        <div class="flex-shrink-0 flex justify-between items-center">
            <p class="font-bold">é¢è¯•æ¼”ç»ƒä¸­ (<span id="question-counter">1/3</span>)</p>
            <button id="close-practice-btn" class="text-2xl">&times;</button>
        </div>
        <div class="flex-grow flex flex-col justify-center items-center text-center w-full">
            <h2 class="text-2xl font-semibold mb-8" id="practice-question"></h2>

            <div id="practice-answering-state" class="w-full max-w-lg text-left">
                <textarea id="answer-textarea" class="w-full h-40 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400" placeholder="è¯·è¾“å…¥ä½ çš„å›ç­”..."></textarea>
                <p class="text-xs text-gray-400 mt-2 text-center">ğŸ’¡ æ‚¨å¯ä»¥ä½¿ç”¨æ‰‹æœºè‡ªå¸¦çš„è¯­éŸ³è¾“å…¥æ³•è¿›è¡Œå›ç­”</p>
                <button id="submit-answer-btn" class="w-full bg-blue-600 text-white font-bold py-3 mt-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-500">æäº¤å›ç­”</button>
            </div>

            <div id="practice-feedback-state" class="hidden w-full max-w-lg text-left bg-gray-700 p-4 rounded-lg">
                <h4 class="font-bold mb-2">ä½ çš„å›ç­”:</h4>
                <p id="user-answer-transcript" class="text-sm mb-4 bg-gray-800 p-2 rounded"></p>
                <h4 class="font-bold mb-2">AI åé¦ˆ:</h4>
                <p id="ai-feedback-text" class="text-sm"></p>
            </div>
        </div>
        <div class="flex-shrink-0 flex justify-between items-center">
            <button id="show-answer-btn" class="bg-gray-700 py-2 px-4 rounded-lg">æŸ¥çœ‹å»ºè®®ç­”æ¡ˆ</button>
            <button id="next-question-btn" class="bg-blue-600 py-2 px-4 rounded-lg">ä¸‹ä¸€é¢˜ &rarr;</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DATA STORE ---
            const params = new URLSearchParams(window.location.search);
            const opportunityData = {
                position: params.get('position') || 'æœºä¼šè¯¦æƒ…',
                company: params.get('company') || 'å…¬å¸ä¿¡æ¯',
                jd: params.get('jd') || 'æœªèƒ½åŠ è½½å²—ä½æè¿°ã€‚',
                generatedResume: null,
                generatedQA: [],
                interviewHistory: []
            };
            let currentQuestionIndex = 0;

            // --- 2. DOM ELEMENTS ---
            const getEl = (id) => document.getElementById(id);
            const queryEl = (sel) => document.querySelector(sel);
            const queryElAll = (sel) => document.querySelectorAll(sel);
            const elements = {
                title: getEl('opportunity-title'),
                company: getEl('opportunity-company'),
                jd: getEl('opportunity-jd'),
                mainActionResume: getEl('main-action-resume'),
                mainActionPractice: getEl('main-action-practice'),
                practiceInitialBtn: getEl('practice-initial-btn'),
                practiceLoadingState: getEl('practice-loading-state'),
                practiceConfirmState: getEl('practice-confirm-state'),
                startPracticeBtn: getEl('start-practice-btn'),
                keywordModal: getEl('keyword-modal'),
                cancelKeywordBtn: getEl('cancel-keyword-btn'),
                generateWithKeywordBtn: getEl('generate-with-keyword-btn'),
                resumeKeywordsInput: getEl('resume-keywords'),
                practiceOverlay: getEl('practice-overlay'),
                secondaryTabs: queryElAll('.secondary-tab'),
                tabContents: queryElAll('.tab-content'),
                resumePlaceholder: getEl('resume-placeholder'),
                resumeContentContainer: getEl('resume-content-container'),
                resumeDisplayMode: getEl('resume-display-mode'),
                resumeEditMode: getEl('resume-edit-mode'),
                resumeEditBtn: getEl('resume-edit-btn'),
                resumeDownloadBtn: getEl('resume-download-btn'),
                resumeSaveBtn: getEl('resume-save-btn'),
                resumeCancelBtn: getEl('resume-cancel-btn'),
                resumeEditor: getEl('resume-editor'),
                resumePreviewArea: getEl('resume-preview-area'),
                qaControls: getEl('qa-controls'),
                qaPlaceholder: getEl('qa-placeholder'),
                qaListContainer: getEl('qa-list-container'),
                addQaBtn: getEl('add-qa-btn'),
                saveQaBtn: getEl('save-qa-btn'),
                reportPlaceholder: getEl('report-placeholder'),
                reportContentContainer: getEl('report-content-container'),
                reportScore: getEl('report-score'),
                reportRadarChart: getEl('report-radar-chart'),
                reportFeedback: getEl('report-feedback'),
                reportSessionDetailsContainer: getEl('report-session-details-container'),
                reportSessionDetails: getEl('report-session-details'),
                reportHistoryList: getEl('report-history-list'),
                closePracticeBtn: getEl('close-practice-btn'),
                practiceQuestion: getEl('practice-question'),
                questionCounter: getEl('question-counter'),
                practiceAnsweringState: getEl('practice-answering-state'),
                practiceFeedbackState: getEl('practice-feedback-state'),
                answerTextarea: getEl('answer-textarea'),
                submitAnswerBtn: getEl('submit-answer-btn'),
                userAnswerTranscript: getEl('user-answer-transcript'),
                aiFeedbackText: getEl('ai-feedback-text'),
                nextQuestionBtn: getEl('next-question-btn'),
                showAnswerBtn: getEl('show-answer-btn'),

                // New elements for JD analysis
                analyzeJdBtn: getEl('analyze-jd-btn'),
                jdAnalysisResults: getEl('jd-analysis-results'),
                keywordsList: getEl('keywords-list'),
                preMatchText: getEl('pre-match-text'),
            };

            // --- 3. INITIAL PAGE SETUP ---
            elements.title.textContent = opportunityData.position;
            elements.company.textContent = opportunityData.company;
            elements.jd.textContent = opportunityData.jd;

            // --- 4. LOGIC & EVENT HANDLERS ---

            const activateTab = (tabName) => queryEl(`.secondary-tab[data-tab='${tabName}']`)?.click();

            function downloadResumeAsPDF() {
                const resumeContent = elements.resumePreviewArea.innerHTML;
                const position = opportunityData.position;
                const company = opportunityData.company;
                const filename = `${company}_${position}_ç®€å†.pdf`;

                // Create a printable element
                const printElement = document.createElement('div');
                
                // Basic A4 styling
                printElement.style.width = '210mm';
                printElement.style.minHeight = '297mm';
                printElement.style.padding = '20mm';
                printElement.style.fontFamily = `'Helvetica Neue', Helvetica, Arial, sans-serif`;
                printElement.style.fontSize = '11pt';
                printElement.style.color = '#333';
                
                printElement.innerHTML = resumeContent;

                // More specific styling for PDF
                const style = document.createElement('style');
                style.innerHTML = `
                    @media print {
                        body { -webkit-print-color-adjust: exact; }
                    }
                    h1, h2, h3, h4, h5, h6 { 
                        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                        color: #000;
                        margin-top: 1.2em;
                        margin-bottom: 0.6em;
                    }
                    h1 { font-size: 22pt; border-bottom: 2px solid #333; padding-bottom: 4px; margin-bottom: 0.8em;}
                    h3 { font-size: 14pt; border-bottom: 1px solid #ccc; padding-bottom: 2px; }
                    ul { padding-left: 20px; list-style-position: outside;}
                    p, li { line-height: 1.5; }
                    hr { display: none; }
                `;
                printElement.prepend(style);

                const opt = {
                    margin: 0,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Use html2pdf to generate and download
                html2pdf().from(printElement).set(opt).save();
            }

            // 4.1 Secondary Tabs Logic
            elements.secondaryTabs.forEach(button => {
                button.addEventListener('click', () => {
                    elements.secondaryTabs.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    elements.tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-${button.dataset.tab}`));
                });
            });

            // 4.2 Resume Generation Logic
            elements.mainActionResume.addEventListener('click', () => elements.keywordModal.classList.remove('hidden'));
            elements.cancelKeywordBtn.addEventListener('click', () => elements.keywordModal.classList.add('hidden'));
            elements.generateWithKeywordBtn.addEventListener('click', () => {
                const keywords = elements.resumeKeywordsInput.value;
                elements.keywordModal.classList.add('hidden');
                elements.mainActionResume.disabled = true;
                elements.mainActionResume.querySelector('h2').textContent = 'AI æ­£åœ¨ç”Ÿæˆä¸­...';
                setTimeout(() => {
                    const generatedMd = `# ç®€å† for ${opportunityData.position}\n\n## é‡ç‚¹çªå‡ºäº† ${keywords || 'AIè‡ªåŠ¨åˆ¤æ–­'} çš„æ–¹é¢\n... (è¿™é‡Œæ˜¯AIç”Ÿæˆçš„ç®€å†å†…å®¹) ...`;
                    opportunityData.generatedResume = generatedMd;
                    elements.resumeEditor.value = generatedMd;
                    elements.resumePreviewArea.innerHTML = marked.parse(generatedMd);
                    elements.resumePlaceholder.classList.add('hidden');
                    elements.resumeContentContainer.classList.remove('hidden');
                    elements.resumeDownloadBtn.classList.remove('hidden');
                    elements.resumeEditMode.classList.add('hidden');
                    elements.resumeDisplayMode.classList.remove('hidden');
                    showToast("ç®€å†å·²ç”Ÿæˆï¼è¯·åœ¨ä¸‹æ–¹â€œç®€å†è¯¦æƒ…â€Tabä¸­æŸ¥çœ‹ã€‚");
                    elements.mainActionResume.disabled = false;
                    elements.mainActionResume.querySelector('h2').textContent = 'AI ç”Ÿæˆå®šåˆ¶ç®€å†';
                }, 1500);
            });
            elements.resumeEditBtn.addEventListener('click', () => {
                elements.resumeDisplayMode.classList.add('hidden');
                elements.resumeEditMode.classList.remove('hidden');
            });
            elements.resumeCancelBtn.addEventListener('click', () => {
                elements.resumeEditor.value = opportunityData.generatedResume;
                elements.resumeEditMode.classList.add('hidden');
                elements.resumeDisplayMode.classList.remove('hidden');
            });
            elements.resumeSaveBtn.addEventListener('click', () => {
                opportunityData.generatedResume = elements.resumeEditor.value;
                elements.resumePreviewArea.innerHTML = marked.parse(opportunityData.generatedResume);
                elements.resumeEditMode.classList.add('hidden');
                elements.resumeDisplayMode.classList.remove('hidden');
                showToast('ç®€å†ä¿®æ”¹å·²ä¿å­˜ï¼');
            });
            elements.resumeDownloadBtn.addEventListener('click', downloadResumeAsPDF);

            // 4.3 Q&A Section Logic
            function renderQaList() {
                if (opportunityData.generatedQA.length === 0) {
                    elements.qaPlaceholder.classList.remove('hidden');
                    elements.qaControls.classList.add('hidden');
                    elements.qaListContainer.innerHTML = '';
                } else {
                    elements.qaPlaceholder.classList.add('hidden');
                    elements.qaControls.classList.remove('hidden');
                    const qaHtml = opportunityData.generatedQA.map(item => `
                        <div class="qa-item bg-gray-50 p-3 rounded-lg border" data-id="${item.id}">
                            <div class="flex justify-between items-start mb-2">
                                <textarea rows="1" class="question-input font-semibold border-b-2 w-full focus:border-blue-500 outline-none bg-transparent resize-none p-1">${item.q}</textarea>
                                <button class="delete-qa-btn text-gray-400 hover:text-red-600 ml-2 flex-shrink-0 p-1"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <textarea class="answer-input w-full p-2 border rounded-md text-sm" rows="4">${item.a}</textarea>
                        </div>
                    `).join('');
                    elements.qaListContainer.innerHTML = qaHtml;
                }
            }
            elements.addQaBtn.addEventListener('click', () => {
                opportunityData.generatedQA.unshift({ id: Date.now(), q: 'æ–°é—®é¢˜...', a: 'æ–°ç­”æ¡ˆ...' });
                renderQaList();
            });
            elements.saveQaBtn.addEventListener('click', () => {
                const qaItems = queryElAll('.qa-item');
                const newQAData = Array.from(qaItems).map(item => ({
                    id: item.dataset.id,
                    q: item.querySelector('.question-input').value,
                    a: item.querySelector('.answer-input').value
                })).reverse();
                opportunityData.generatedQA = newQAData;
                showToast('é—®ç­”åˆ—è¡¨å·²ä¿å­˜ï¼');
            });
            elements.qaListContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-qa-btn');
                if (deleteBtn) {
                    const idToDelete = deleteBtn.closest('.qa-item').dataset.id;
                    showConfirm('ç¡®è®¤åˆ é™¤', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®é¢˜å—ï¼Ÿ', (confirmed) => {
                        if (confirmed) {
                            opportunityData.generatedQA = opportunityData.generatedQA.filter(item => String(item.id) !== idToDelete);
                            renderQaList();
                            showToast('åˆ é™¤æˆåŠŸ');
                        }
                    });
                }
            });

            // 4.4 Interview Practice & Report Logic


            function renderHistoryList() {
                if (opportunityData.interviewHistory.length === 0) {
                    elements.reportPlaceholder.classList.remove('hidden');
                    elements.reportContentContainer.classList.add('hidden');
                    return;
                }
                elements.reportHistoryList.innerHTML = opportunityData.interviewHistory.map(session => `
                    <div class="history-item flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm cursor-pointer hover:bg-gray-100" data-session-id="${session.id}">
                        <span><i class="fas fa-history mr-2 text-gray-400"></i>${session.date} æ¨¡æ‹Ÿé¢è¯•</span>
                        <span class="font-semibold text-blue-600">${session.score}åˆ†</span>
                    </div>`).join('');
            }

            function loadReport(sessionId) {
                const session = opportunityData.interviewHistory.find(s => s.id === sessionId);
                if (!session) return;

                elements.reportPlaceholder.classList.add('hidden');
                elements.reportContentContainer.classList.remove('hidden');

                elements.reportScore.textContent = session.score;
                elements.reportFeedback.textContent = session.summary;

                elements.reportSessionDetails.innerHTML = session.answeredQuestions.map(qa => `
                    <div class="bg-gray-50 p-3 rounded-lg border">
                        <p class="font-semibold text-gray-800">${qa.q}</p>
                        <p class="text-xs text-gray-500 mt-2">ä½ çš„å›ç­”:</p>
                        <p class="text-sm text-gray-700 p-2 bg-white rounded mt-1">${qa.a}</p>
                        <p class="text-xs text-gray-500 mt-2">AIåé¦ˆ:</p>
                        <p class="text-sm text-green-700 p-2 bg-green-50 rounded mt-1">${qa.feedback}</p>
                    </div>`).join('');
                elements.reportSessionDetailsContainer.classList.remove('hidden');
            }

            function finishInterview(isInterrupted = false) {
                elements.practiceOverlay.classList.add('hidden');
                const questionsInSession = opportunityData.generatedQA.slice(0, currentQuestionIndex + 1);
                const score = Math.floor(Math.random() * 21) + 75; // Random score 75-95
                let summary = "æœ¬æ¬¡é¢è¯•è¡¨ç°å‡ºè‰²ï¼Œæ²Ÿé€šæµç•…ï¼ŒæŠ€æœ¯çŸ¥è¯†æ‰å®ã€‚åœ¨å›ç­”å…³äºé¡¹ç›®æŒ‘æˆ˜çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥æ›´å¤šåœ°ä½¿ç”¨STARåŸåˆ™æ¥æ„å»ºå›ç­”ï¼Œä½¿é€»è¾‘æ›´æ¸…æ™°ã€‚";
                if (isInterrupted) {
                    summary += ` (æœ¬æ¬¡è¯„ä¼°åŸºäºæ‚¨å·²å›ç­”çš„ ${questionsInSession.length} ä¸ªé—®é¢˜ç”Ÿæˆã€‚)`
                }

                const newSession = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('zh-CN'),
                    score: score,
                    summary: summary,
                    answeredQuestions: questionsInSession.map(qa => ({
                        q: qa.q,
                        a: "è¿™æ˜¯ç”¨æˆ·å›ç­”çš„æ¨¡æ‹Ÿæ–‡å­—è®°å½•ã€‚", // Mock user answer
                        feedback: "AIå¯¹è¿™ä¸ªå›ç­”çš„æ¨¡æ‹Ÿåé¦ˆï¼šé€»è¾‘æ¸…æ™°ï¼Œè¡¨è¾¾æµç•…ã€‚" // Mock feedback
                    }))
                };
                opportunityData.interviewHistory.unshift(newSession);

                showToast("é¢è¯•å®Œæˆï¼æ­£åœ¨ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š...");
                setTimeout(() => {
                    renderHistoryList();
                    loadReport(newSession.id);
                    activateTab('report');
                }, 500);
            }

            elements.mainActionPractice.addEventListener('click', () => {
                elements.practiceInitialBtn.classList.add('hidden');
                elements.practiceLoadingState.classList.remove('hidden');
                setTimeout(() => {
                    if (opportunityData.generatedQA.length === 0) {
                        opportunityData.generatedQA = [
                            { id: Date.now()+1, q: 'è®²ä¸€ä¸ªä½ å‚ä¸è¿‡çš„æœ€æœ‰æŒ‘æˆ˜æ€§çš„é¡¹ç›®ã€‚', a: 'STARåŸåˆ™...' },
                            { id: Date.now()+2, q: 'ä½ ä¼šå¦‚ä½•ä¼˜åŒ–ä¸€ä¸ªReactåº”ç”¨çš„æ€§èƒ½ï¼Ÿ', a: 'æˆ‘ä¼šä»...' },
                            { id: Date.now()+3, q: 'ä½ å¯¹æˆ‘ä»¬å…¬å¸æœ‰ä»€ä¹ˆäº†è§£ï¼Ÿ', a: 'æˆ‘äº†è§£åˆ°è´µå…¬å¸...' }
                        ];
                    }
                    renderQaList(); // Restored this call
                    elements.practiceLoadingState.classList.add('hidden');
                    elements.practiceConfirmState.classList.remove('hidden');
                }, 1500);
            });

            elements.startPracticeBtn.addEventListener('click', () => {
                currentQuestionIndex = 0;
                displayQuestion(currentQuestionIndex);
                elements.practiceOverlay.classList.remove('hidden');
            });

            function displayQuestion(index) {
                elements.practiceQuestion.textContent = opportunityData.generatedQA[index].q;
                elements.questionCounter.textContent = `${index + 1}/${opportunityData.generatedQA.length}`;
                elements.practiceAnsweringState.classList.remove('hidden');
                elements.practiceFeedbackState.classList.add('hidden');
                elements.answerTextarea.value = ''; // Clear textarea
                elements.submitAnswerBtn.disabled = true; // Disable button initially
                
                if (index === opportunityData.generatedQA.length - 1) {
                    elements.nextQuestionBtn.textContent = 'å®Œæˆé¢è¯•ï¼ŒæŸ¥çœ‹è¯„ä¼°';
                    elements.nextQuestionBtn.classList.replace('bg-blue-600', 'bg-green-600');
                } else {
                    elements.nextQuestionBtn.textContent = 'ä¸‹ä¸€é¢˜ â†’';
                    elements.nextQuestionBtn.classList.replace('bg-green-600', 'bg-blue-600');
                }
            }

            elements.answerTextarea.addEventListener('input', () => {
                elements.submitAnswerBtn.disabled = elements.answerTextarea.value.trim() === '';
            });

            elements.submitAnswerBtn.addEventListener('click', () => {
                const answer = elements.answerTextarea.value;
                elements.userAnswerTranscript.textContent = answer;
                elements.aiFeedbackText.textContent = "æ¨¡æ‹ŸAIåé¦ˆï¼šå›ç­”å¾—ä¸é”™ï¼Œé€»è¾‘æ¸…æ™°ã€‚å¯ä»¥å°è¯•è¡¥å……æ›´å¤šæ•°æ®æ¥æ”¯æ’‘ä½ çš„è®ºç‚¹ã€‚";
                elements.practiceAnsweringState.classList.add('hidden');
                elements.practiceFeedbackState.classList.remove('hidden');
            });

            elements.closePracticeBtn.addEventListener('click', () => {
                showConfirm('æå‰ç»“æŸ', 'æ‚¨ç¡®å®šè¦æå‰ç»“æŸæœ¬æ¬¡é¢è¯•å—ï¼Ÿç³»ç»Ÿå°†æ ¹æ®æ‚¨å·²å®Œæˆçš„å›ç­”ç”Ÿæˆä¸€ä»½è¯„ä¼°æŠ¥å‘Šã€‚', (confirmed) => {
                    if (confirmed) {
                        finishInterview(true);
                    }
                });
            });

            elements.nextQuestionBtn.addEventListener('click', () => {
                // Check if feedback for the current question has been shown
                if (elements.practiceFeedbackState.classList.contains('hidden')) {
                    showToast('è¯·å…ˆæäº¤å½“å‰é—®é¢˜çš„å›ç­”ã€‚');
                    return;
                }

                if (currentQuestionIndex === opportunityData.generatedQA.length - 1) {
                    finishInterview(false);
                } else {
                    currentQuestionIndex++;
                    displayQuestion(currentQuestionIndex);
                }
            });

            elements.reportHistoryList.addEventListener('click', (e) => {
                const historyItem = e.target.closest('.history-item');
                if (historyItem) {
                    const sessionId = parseInt(historyItem.dataset.sessionId, 10);
                    loadReport(sessionId);
                }
            });

            elements.showAnswerBtn.addEventListener('click', () => {
                showAlert('å»ºè®®ç­”æ¡ˆ', opportunityData.generatedQA[currentQuestionIndex].a);
            });

            // --- New JD Analysis Logic ---
            elements.analyzeJdBtn.addEventListener('click', () => {
                elements.analyzeJdBtn.disabled = true;
                elements.analyzeJdBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AIåˆ†æä¸­...';
                elements.jdAnalysisResults.classList.add('hidden');

                setTimeout(() => {
                    // Mock Keywords (replace with actual AI output)
                    const mockKeywords = ['JavaScript', 'React', 'Node.js', 'æ•°æ®ç»“æ„', 'ç®—æ³•', 'å›¢é˜Ÿåä½œ', 'é¡¹ç›®ç®¡ç†'];
                    elements.keywordsList.innerHTML = mockKeywords.map(kw => `<span class="bg-blue-200 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${kw}</span>`).join('');

                    // Mock User Profile (replace with actual user data from profile.html)
                    const mockUserProfile = {
                        skills: ['JavaScript', 'Java', 'Python', 'Vue.js'],
                        projects: ['ç”µå•†å¹³å° (React)', 'å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ (Flask)'],
                        experience: ['å›¢é˜Ÿåä½œ', 'é¡¹ç›®ç®¡ç†']
                    };

                    let preMatchFeedback = 'æ ¹æ®æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œä¸è¯¥å²—ä½JDåŒ¹é…åº¦è¾ƒé«˜ã€‚ç‰¹åˆ«æ˜¯**JavaScript**å’Œ**React**ç»éªŒéå¸¸å»åˆã€‚' +
                                            'å»ºè®®åœ¨ç®€å†ä¸­è¿›ä¸€æ­¥çªå‡ºæ‚¨åœ¨**Node.js**å’Œ**ç®—æ³•**æ–¹é¢çš„ç»éªŒï¼Œä»¥æé«˜åŒ¹é…åº¦.';
                    
                    elements.preMatchText.textContent = preMatchFeedback;

                    elements.jdAnalysisResults.classList.remove('hidden');
                    elements.analyzeJdBtn.disabled = false;
                    elements.analyzeJdBtn.innerHTML = '<i class="fas fa-brain mr-2"></i>AIåˆ†æJD';
                }, 2000);
            });
        });
    </script>
</body>
</html>