<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>机会详情 - AI面试助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="dialog.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .prose h1, .prose h2, .prose h3 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .prose h1 { font-size: 1.5rem; } .prose h2 { font-size: 1.25rem; } .prose h3 { font-size: 1.1rem; }
        .prose p { margin-bottom: 1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .secondary-tab.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
    </style>
</head>
<body class="pb-20">
    <!-- Header -->
    <div class="bg-white shadow-sm pb-4">
        <div class="container mx-auto p-4">
            <!-- <a href="opportunities.html" class="text-blue-600 text-sm mb-2 block">&larr; 返回列表</a> -->
            <h1 id="opportunity-title" class="text-2xl font-bold text-gray-800"></h1>
            <p id="opportunity-company" class="text-gray-500"></p>
        </div>
    </div>

    <!-- Main AI Actions -->
    <div class="container mx-auto p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="w-full bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow border-l-4 border-blue-500">
                 <button id="main-action-resume" class="w-full text-left">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">✨</div>
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">AI 生成定制简历</h2>
                            <p class="text-sm text-gray-500 mt-1">根据JD和你的背景，量身打造简历</p>
                        </div>
                    </div>
                </button>
            </div>
            <div id="practice-action-container" class="w-full bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                <div id="practice-initial-btn">
                    <button id="main-action-practice" class="w-full text-left">
                        <div class="flex items-center">
                            <div class="text-3xl mr-4">🎙️</div>
                            <div>
                                <h2 class="font-bold text-lg text-gray-800">AI 进行面试演练</h2>
                                <p class="text-sm text-gray-500 mt-1">模拟实战，预测问题并练习回答</p>
                            </div>
                        </div>
                    </button>
                </div>
                <div id="practice-loading-state" class="hidden">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4 animate-spin"><i class="fas fa-spinner"></i></div>
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">AI 正在生成问题...</h2>
                            <p class="text-sm text-gray-500 mt-1">请稍候，正在分析JD和简历</p>
                        </div>
                    </div>
                </div>
                <div id="practice-confirm-state" class="hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="font-bold text-lg text-green-600">AI 已为您生成 3 个高频问题！</h2>
                            <p class="text-sm text-gray-500 mt-1">准备好挑战了吗？</p>
                        </div>
                        <button id="start-practice-btn" class="bg-purple-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-purple-700">立即开始</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Content (Details) -->
    <div class="container mx-auto p-4">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button class="secondary-tab active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm" data-tab="details">职位详情</button>
                <button class="secondary-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="resume">简历详情</button>
                <button class="secondary-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="qa">问答详情</button>
                <button class="secondary-tab whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500" data-tab="report">评估报告</button>
            </nav>
        </div>
        <div class="mt-4 bg-white p-4 rounded-xl shadow-sm min-h-[400px]">
            <div id="tab-details" class="tab-content space-y-4">
                <h3 class="font-bold text-gray-700 mb-2">岗位描述 (JD)</h3>
                <p id="opportunity-jd" class="text-sm text-gray-600 leading-relaxed whitespace-pre-line"></p>
                <button id="analyze-jd-btn" class="mt-4 bg-blue-500 text-white text-sm font-semibold py-2 px-4 rounded-md hover:bg-blue-600"><i class="fas fa-brain mr-2"></i>AI分析JD</button>

                <div id="jd-analysis-results" class="mt-6 hidden">
                    <div id="jd-keywords-analysis" class="bg-blue-50 p-4 rounded-lg shadow-sm mb-4">
                        <h4 class="font-bold text-blue-800 mb-2">核心关键词</h4>
                        <div id="keywords-list" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div id="resume-pre-match-analysis" class="bg-green-50 p-4 rounded-lg shadow-sm">
                        <h4 class="font-bold text-green-800 mb-2">简历预匹配分析</h4>
                        <p id="pre-match-text" class="text-sm text-green-700"></p>
                    </div>
                </div>
            </div>
            <div id="tab-resume" class="tab-content hidden">
                <div id="resume-placeholder">
                    <p class="text-gray-400 p-4 text-center">尚未生成简历。请点击上方的“AI生成定制简历”按钮开始。</p>
                </div>
                <div id="resume-content-container" class="hidden">
                    <div id="resume-display-mode">
                        <div class="flex justify-end mb-2 space-x-2">
                            <button id="resume-download-btn" class="bg-blue-500 text-white text-sm font-semibold py-1 px-3 rounded-md hover:bg-blue-600">下载PDF</button>
                            <button id="resume-edit-btn" class="bg-gray-200 text-sm font-semibold py-1 px-3 rounded-md hover:bg-gray-300">编辑</button>
                        </div>
                        <div id="resume-preview-area" class="prose p-4 border rounded bg-gray-50 min-h-[200px]"></div>
                    </div>
                    <div id="resume-edit-mode" class="hidden">
                        <textarea id="resume-editor" class="w-full p-2 border rounded" rows="20"></textarea>
                        <div class="mt-2 flex justify-end space-x-2">
                            <button id="resume-cancel-btn" class="bg-gray-500 text-white text-sm py-1 px-3 rounded-md">取消</button>
                            <button id="resume-save-btn" class="bg-green-600 text-white text-sm py-1 px-3 rounded-md">保存</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="tab-qa" class="tab-content hidden">
                <div id="qa-controls" class="hidden flex justify-end space-x-2 mb-4">
                    <button id="add-qa-btn" class="bg-blue-500 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-blue-600">+ 新增问答</button>
                    <button id="save-qa-btn" class="bg-green-600 text-white text-sm font-bold py-2 px-3 rounded-lg hover:bg-green-700">保存全部修改</button>
                </div>
                <p id="qa-placeholder" class="text-gray-400 p-4 text-center">尚未生成问答。请点击上方的“AI进行面试演练”按钮开始。</p>
                <div id="qa-list-container" class="space-y-4"></div>
            </div>
            <div id="tab-report" class="tab-content hidden">
                <div id="report-placeholder">
                    <p class="text-gray-400 p-4 text-center">尚未进行面试演练，暂无评估报告。</p>
                </div>
                <div id="report-content-container" class="hidden space-y-6">
                    <!-- Overall Score -->
                    <div class="text-center">
                        <p class="text-sm text-gray-500">综合评分</p>
                        <p id="report-score" class="text-6xl font-bold text-blue-600"></p>
                    </div>
                    <!-- Bar Chart -->
                    <div id="report-bar-chart" class="space-y-3 my-6">
                        <!-- Skill Item 1 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">沟通能力</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 85%;">85</div>
                            </div>
                        </div>
                        <!-- Skill Item 2 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">技术深度</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 90%;">90</div>
                            </div>
                        </div>
                        <!-- Skill Item 3 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">逻辑思维</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 80%;">80</div>
                            </div>
                        </div>
                        <!-- Skill Item 4 -->
                        <div class="flex items-center space-x-3">
                            <span class="w-24 text-sm font-medium text-gray-600 shrink-0">STAR原则</span>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="bg-blue-500 h-5 rounded-full text-right pr-2 text-white text-xs leading-5 flex items-center justify-end" style="width: 75%;">75</div>
                            </div>
                        </div>
                    </div>
                    <!-- Overall Feedback -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">整体评价</h3>
                        <p id="report-feedback" class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg"></p>
                    </div>
                     <!-- Session Details -->
                    <div id="report-session-details-container" class="hidden">
                        <h3 class="font-bold text-gray-700 mb-2">会话详情</h3>
                        <div id="report-session-details" class="space-y-3"></div>
                    </div>
                    <!-- History -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">历史记录</h3>
                        <div id="report-history-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS AND OVERLAYS -->
    <div id="keyword-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm mx-auto p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-2">关键词引导</h3>
            <p class="text-sm text-gray-500 mb-4">输入希望AI重点突出的关键词（可选）</p>
            <input type="text" id="resume-keywords" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="例如: Vue3, 团队合作">
            <div class="mt-5 flex justify-end space-x-3">
                <button id="cancel-keyword-btn" class="px-4 py-2 bg-gray-200 rounded-md text-sm font-medium">取消</button>
                <button id="generate-with-keyword-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium">确认生成</button>
            </div>
        </div>
    </div>
    <div id="practice-overlay" class="hidden fixed inset-0 bg-gray-800 z-50 p-6 flex flex-col text-white">
        <div class="flex-shrink-0 flex justify-between items-center">
            <p class="font-bold">面试演练中 (<span id="question-counter">1/3</span>)</p>
            <button id="close-practice-btn" class="text-2xl">&times;</button>
        </div>
        <div class="flex-grow flex flex-col justify-center items-center text-center w-full">
            <h2 class="text-2xl font-semibold mb-8" id="practice-question"></h2>

            <div id="practice-answering-state" class="w-full max-w-lg text-left">
                <textarea id="answer-textarea" class="w-full h-40 p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400" placeholder="请输入你的回答..."></textarea>
                <p class="text-xs text-gray-400 mt-2 text-center">💡 您可以使用手机自带的语音输入法进行回答</p>
                <button id="submit-answer-btn" class="w-full bg-blue-600 text-white font-bold py-3 mt-4 rounded-lg hover:bg-blue-700 disabled:bg-gray-500">提交回答</button>
            </div>

            <div id="practice-feedback-state" class="hidden w-full max-w-lg text-left bg-gray-700 p-4 rounded-lg">
                <h4 class="font-bold mb-2">你的回答:</h4>
                <p id="user-answer-transcript" class="text-sm mb-4 bg-gray-800 p-2 rounded"></p>
                <h4 class="font-bold mb-2">AI 反馈:</h4>
                <p id="ai-feedback-text" class="text-sm"></p>
            </div>
        </div>
        <div class="flex-shrink-0 flex justify-between items-center">
            <button id="show-answer-btn" class="bg-gray-700 py-2 px-4 rounded-lg">查看建议答案</button>
            <button id="next-question-btn" class="bg-blue-600 py-2 px-4 rounded-lg">下一题 &rarr;</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. DATA STORE ---
            const params = new URLSearchParams(window.location.search);
            const opportunityData = {
                position: params.get('position') || '机会详情',
                company: params.get('company') || '公司信息',
                jd: params.get('jd') || '未能加载岗位描述。',
                generatedResume: null,
                generatedQA: [],
                interviewHistory: []
            };
            let currentQuestionIndex = 0;

            // --- 2. DOM ELEMENTS ---
            const getEl = (id) => document.getElementById(id);
            const queryEl = (sel) => document.querySelector(sel);
            const queryElAll = (sel) => document.querySelectorAll(sel);
            const elements = {
                title: getEl('opportunity-title'),
                company: getEl('opportunity-company'),
                jd: getEl('opportunity-jd'),
                mainActionResume: getEl('main-action-resume'),
                mainActionPractice: getEl('main-action-practice'),
                practiceInitialBtn: getEl('practice-initial-btn'),
                practiceLoadingState: getEl('practice-loading-state'),
                practiceConfirmState: getEl('practice-confirm-state'),
                startPracticeBtn: getEl('start-practice-btn'),
                keywordModal: getEl('keyword-modal'),
                cancelKeywordBtn: getEl('cancel-keyword-btn'),
                generateWithKeywordBtn: getEl('generate-with-keyword-btn'),
                resumeKeywordsInput: getEl('resume-keywords'),
                practiceOverlay: getEl('practice-overlay'),
                secondaryTabs: queryElAll('.secondary-tab'),
                tabContents: queryElAll('.tab-content'),
                resumePlaceholder: getEl('resume-placeholder'),
                resumeContentContainer: getEl('resume-content-container'),
                resumeDisplayMode: getEl('resume-display-mode'),
                resumeEditMode: getEl('resume-edit-mode'),
                resumeEditBtn: getEl('resume-edit-btn'),
                resumeDownloadBtn: getEl('resume-download-btn'),
                resumeSaveBtn: getEl('resume-save-btn'),
                resumeCancelBtn: getEl('resume-cancel-btn'),
                resumeEditor: getEl('resume-editor'),
                resumePreviewArea: getEl('resume-preview-area'),
                qaControls: getEl('qa-controls'),
                qaPlaceholder: getEl('qa-placeholder'),
                qaListContainer: getEl('qa-list-container'),
                addQaBtn: getEl('add-qa-btn'),
                saveQaBtn: getEl('save-qa-btn'),
                reportPlaceholder: getEl('report-placeholder'),
                reportContentContainer: getEl('report-content-container'),
                reportScore: getEl('report-score'),
                reportRadarChart: getEl('report-radar-chart'),
                reportFeedback: getEl('report-feedback'),
                reportSessionDetailsContainer: getEl('report-session-details-container'),
                reportSessionDetails: getEl('report-session-details'),
                reportHistoryList: getEl('report-history-list'),
                closePracticeBtn: getEl('close-practice-btn'),
                practiceQuestion: getEl('practice-question'),
                questionCounter: getEl('question-counter'),
                practiceAnsweringState: getEl('practice-answering-state'),
                practiceFeedbackState: getEl('practice-feedback-state'),
                answerTextarea: getEl('answer-textarea'),
                submitAnswerBtn: getEl('submit-answer-btn'),
                userAnswerTranscript: getEl('user-answer-transcript'),
                aiFeedbackText: getEl('ai-feedback-text'),
                nextQuestionBtn: getEl('next-question-btn'),
                showAnswerBtn: getEl('show-answer-btn'),

                // New elements for JD analysis
                analyzeJdBtn: getEl('analyze-jd-btn'),
                jdAnalysisResults: getEl('jd-analysis-results'),
                keywordsList: getEl('keywords-list'),
                preMatchText: getEl('pre-match-text'),
            };

            // --- 3. INITIAL PAGE SETUP ---
            elements.title.textContent = opportunityData.position;
            elements.company.textContent = opportunityData.company;
            elements.jd.textContent = opportunityData.jd;

            // --- 4. LOGIC & EVENT HANDLERS ---

            const activateTab = (tabName) => queryEl(`.secondary-tab[data-tab='${tabName}']`)?.click();

            function downloadResumeAsPDF() {
                const resumeContent = elements.resumePreviewArea.innerHTML;
                const position = opportunityData.position;
                const company = opportunityData.company;
                const filename = `${company}_${position}_简历.pdf`;

                // Create a printable element
                const printElement = document.createElement('div');
                
                // Basic A4 styling
                printElement.style.width = '210mm';
                printElement.style.minHeight = '297mm';
                printElement.style.padding = '20mm';
                printElement.style.fontFamily = `'Helvetica Neue', Helvetica, Arial, sans-serif`;
                printElement.style.fontSize = '11pt';
                printElement.style.color = '#333';
                
                printElement.innerHTML = resumeContent;

                // More specific styling for PDF
                const style = document.createElement('style');
                style.innerHTML = `
                    @media print {
                        body { -webkit-print-color-adjust: exact; }
                    }
                    h1, h2, h3, h4, h5, h6 { 
                        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
                        color: #000;
                        margin-top: 1.2em;
                        margin-bottom: 0.6em;
                    }
                    h1 { font-size: 22pt; border-bottom: 2px solid #333; padding-bottom: 4px; margin-bottom: 0.8em;}
                    h3 { font-size: 14pt; border-bottom: 1px solid #ccc; padding-bottom: 2px; }
                    ul { padding-left: 20px; list-style-position: outside;}
                    p, li { line-height: 1.5; }
                    hr { display: none; }
                `;
                printElement.prepend(style);

                const opt = {
                    margin: 0,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Use html2pdf to generate and download
                html2pdf().from(printElement).set(opt).save();
            }

            // 4.1 Secondary Tabs Logic
            elements.secondaryTabs.forEach(button => {
                button.addEventListener('click', () => {
                    elements.secondaryTabs.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    elements.tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-${button.dataset.tab}`));
                });
            });

            // 4.2 Resume Generation Logic
            elements.mainActionResume.addEventListener('click', () => elements.keywordModal.classList.remove('hidden'));
            elements.cancelKeywordBtn.addEventListener('click', () => elements.keywordModal.classList.add('hidden'));
            elements.generateWithKeywordBtn.addEventListener('click', () => {
                const keywords = elements.resumeKeywordsInput.value;
                elements.keywordModal.classList.add('hidden');
                elements.mainActionResume.disabled = true;
                elements.mainActionResume.querySelector('h2').textContent = 'AI 正在生成中...';
                setTimeout(() => {
                    const generatedMd = `# 简历 for ${opportunityData.position}\n\n## 重点突出了 ${keywords || 'AI自动判断'} 的方面\n... (这里是AI生成的简历内容) ...`;
                    opportunityData.generatedResume = generatedMd;
                    elements.resumeEditor.value = generatedMd;
                    elements.resumePreviewArea.innerHTML = marked.parse(generatedMd);
                    elements.resumePlaceholder.classList.add('hidden');
                    elements.resumeContentContainer.classList.remove('hidden');
                    elements.resumeDownloadBtn.classList.remove('hidden');
                    elements.resumeEditMode.classList.add('hidden');
                    elements.resumeDisplayMode.classList.remove('hidden');
                    showToast("简历已生成！请在下方“简历详情”Tab中查看。");
                    elements.mainActionResume.disabled = false;
                    elements.mainActionResume.querySelector('h2').textContent = 'AI 生成定制简历';
                }, 1500);
            });
            elements.resumeEditBtn.addEventListener('click', () => {
                elements.resumeDisplayMode.classList.add('hidden');
                elements.resumeEditMode.classList.remove('hidden');
            });
            elements.resumeCancelBtn.addEventListener('click', () => {
                elements.resumeEditor.value = opportunityData.generatedResume;
                elements.resumeEditMode.classList.add('hidden');
                elements.resumeDisplayMode.classList.remove('hidden');
            });
            elements.resumeSaveBtn.addEventListener('click', () => {
                opportunityData.generatedResume = elements.resumeEditor.value;
                elements.resumePreviewArea.innerHTML = marked.parse(opportunityData.generatedResume);
                elements.resumeEditMode.classList.add('hidden');
                elements.resumeDisplayMode.classList.remove('hidden');
                showToast('简历修改已保存！');
            });
            elements.resumeDownloadBtn.addEventListener('click', downloadResumeAsPDF);

            // 4.3 Q&A Section Logic
            function renderQaList() {
                if (opportunityData.generatedQA.length === 0) {
                    elements.qaPlaceholder.classList.remove('hidden');
                    elements.qaControls.classList.add('hidden');
                    elements.qaListContainer.innerHTML = '';
                } else {
                    elements.qaPlaceholder.classList.add('hidden');
                    elements.qaControls.classList.remove('hidden');
                    const qaHtml = opportunityData.generatedQA.map(item => `
                        <div class="qa-item bg-gray-50 p-3 rounded-lg border" data-id="${item.id}">
                            <div class="flex justify-between items-start mb-2">
                                <textarea rows="1" class="question-input font-semibold border-b-2 w-full focus:border-blue-500 outline-none bg-transparent resize-none p-1">${item.q}</textarea>
                                <button class="delete-qa-btn text-gray-400 hover:text-red-600 ml-2 flex-shrink-0 p-1"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <textarea class="answer-input w-full p-2 border rounded-md text-sm" rows="4">${item.a}</textarea>
                        </div>
                    `).join('');
                    elements.qaListContainer.innerHTML = qaHtml;
                }
            }
            elements.addQaBtn.addEventListener('click', () => {
                opportunityData.generatedQA.unshift({ id: Date.now(), q: '新问题...', a: '新答案...' });
                renderQaList();
            });
            elements.saveQaBtn.addEventListener('click', () => {
                const qaItems = queryElAll('.qa-item');
                const newQAData = Array.from(qaItems).map(item => ({
                    id: item.dataset.id,
                    q: item.querySelector('.question-input').value,
                    a: item.querySelector('.answer-input').value
                })).reverse();
                opportunityData.generatedQA = newQAData;
                showToast('问答列表已保存！');
            });
            elements.qaListContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-qa-btn');
                if (deleteBtn) {
                    const idToDelete = deleteBtn.closest('.qa-item').dataset.id;
                    showConfirm('确认删除', '确定要删除这个问题吗？', (confirmed) => {
                        if (confirmed) {
                            opportunityData.generatedQA = opportunityData.generatedQA.filter(item => String(item.id) !== idToDelete);
                            renderQaList();
                            showToast('删除成功');
                        }
                    });
                }
            });

            // 4.4 Interview Practice & Report Logic


            function renderHistoryList() {
                if (opportunityData.interviewHistory.length === 0) {
                    elements.reportPlaceholder.classList.remove('hidden');
                    elements.reportContentContainer.classList.add('hidden');
                    return;
                }
                elements.reportHistoryList.innerHTML = opportunityData.interviewHistory.map(session => `
                    <div class="history-item flex justify-between items-center bg-gray-50 p-2 rounded-lg text-sm cursor-pointer hover:bg-gray-100" data-session-id="${session.id}">
                        <span><i class="fas fa-history mr-2 text-gray-400"></i>${session.date} 模拟面试</span>
                        <span class="font-semibold text-blue-600">${session.score}分</span>
                    </div>`).join('');
            }

            function loadReport(sessionId) {
                const session = opportunityData.interviewHistory.find(s => s.id === sessionId);
                if (!session) return;

                elements.reportPlaceholder.classList.add('hidden');
                elements.reportContentContainer.classList.remove('hidden');

                elements.reportScore.textContent = session.score;
                elements.reportFeedback.textContent = session.summary;

                elements.reportSessionDetails.innerHTML = session.answeredQuestions.map(qa => `
                    <div class="bg-gray-50 p-3 rounded-lg border">
                        <p class="font-semibold text-gray-800">${qa.q}</p>
                        <p class="text-xs text-gray-500 mt-2">你的回答:</p>
                        <p class="text-sm text-gray-700 p-2 bg-white rounded mt-1">${qa.a}</p>
                        <p class="text-xs text-gray-500 mt-2">AI反馈:</p>
                        <p class="text-sm text-green-700 p-2 bg-green-50 rounded mt-1">${qa.feedback}</p>
                    </div>`).join('');
                elements.reportSessionDetailsContainer.classList.remove('hidden');
            }

            function finishInterview(isInterrupted = false) {
                elements.practiceOverlay.classList.add('hidden');
                const questionsInSession = opportunityData.generatedQA.slice(0, currentQuestionIndex + 1);
                const score = Math.floor(Math.random() * 21) + 75; // Random score 75-95
                let summary = "本次面试表现出色，沟通流畅，技术知识扎实。在回答关于项目挑战的问题时，可以更多地使用STAR原则来构建回答，使逻辑更清晰。";
                if (isInterrupted) {
                    summary += ` (本次评估基于您已回答的 ${questionsInSession.length} 个问题生成。)`
                }

                const newSession = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('zh-CN'),
                    score: score,
                    summary: summary,
                    answeredQuestions: questionsInSession.map(qa => ({
                        q: qa.q,
                        a: "这是用户回答的模拟文字记录。", // Mock user answer
                        feedback: "AI对这个回答的模拟反馈：逻辑清晰，表达流畅。" // Mock feedback
                    }))
                };
                opportunityData.interviewHistory.unshift(newSession);

                showToast("面试完成！正在生成评估报告...");
                setTimeout(() => {
                    renderHistoryList();
                    loadReport(newSession.id);
                    activateTab('report');
                }, 500);
            }

            elements.mainActionPractice.addEventListener('click', () => {
                elements.practiceInitialBtn.classList.add('hidden');
                elements.practiceLoadingState.classList.remove('hidden');
                setTimeout(() => {
                    if (opportunityData.generatedQA.length === 0) {
                        opportunityData.generatedQA = [
                            { id: Date.now()+1, q: '讲一个你参与过的最有挑战性的项目。', a: 'STAR原则...' },
                            { id: Date.now()+2, q: '你会如何优化一个React应用的性能？', a: '我会从...' },
                            { id: Date.now()+3, q: '你对我们公司有什么了解？', a: '我了解到贵公司...' }
                        ];
                    }
                    renderQaList(); // Restored this call
                    elements.practiceLoadingState.classList.add('hidden');
                    elements.practiceConfirmState.classList.remove('hidden');
                }, 1500);
            });

            elements.startPracticeBtn.addEventListener('click', () => {
                currentQuestionIndex = 0;
                displayQuestion(currentQuestionIndex);
                elements.practiceOverlay.classList.remove('hidden');
            });

            function displayQuestion(index) {
                elements.practiceQuestion.textContent = opportunityData.generatedQA[index].q;
                elements.questionCounter.textContent = `${index + 1}/${opportunityData.generatedQA.length}`;
                elements.practiceAnsweringState.classList.remove('hidden');
                elements.practiceFeedbackState.classList.add('hidden');
                elements.answerTextarea.value = ''; // Clear textarea
                elements.submitAnswerBtn.disabled = true; // Disable button initially
                
                if (index === opportunityData.generatedQA.length - 1) {
                    elements.nextQuestionBtn.textContent = '完成面试，查看评估';
                    elements.nextQuestionBtn.classList.replace('bg-blue-600', 'bg-green-600');
                } else {
                    elements.nextQuestionBtn.textContent = '下一题 →';
                    elements.nextQuestionBtn.classList.replace('bg-green-600', 'bg-blue-600');
                }
            }

            elements.answerTextarea.addEventListener('input', () => {
                elements.submitAnswerBtn.disabled = elements.answerTextarea.value.trim() === '';
            });

            elements.submitAnswerBtn.addEventListener('click', () => {
                const answer = elements.answerTextarea.value;
                elements.userAnswerTranscript.textContent = answer;
                elements.aiFeedbackText.textContent = "模拟AI反馈：回答得不错，逻辑清晰。可以尝试补充更多数据来支撑你的论点。";
                elements.practiceAnsweringState.classList.add('hidden');
                elements.practiceFeedbackState.classList.remove('hidden');
            });

            elements.closePracticeBtn.addEventListener('click', () => {
                showConfirm('提前结束', '您确定要提前结束本次面试吗？系统将根据您已完成的回答生成一份评估报告。', (confirmed) => {
                    if (confirmed) {
                        finishInterview(true);
                    }
                });
            });

            elements.nextQuestionBtn.addEventListener('click', () => {
                // Check if feedback for the current question has been shown
                if (elements.practiceFeedbackState.classList.contains('hidden')) {
                    showToast('请先提交当前问题的回答。');
                    return;
                }

                if (currentQuestionIndex === opportunityData.generatedQA.length - 1) {
                    finishInterview(false);
                } else {
                    currentQuestionIndex++;
                    displayQuestion(currentQuestionIndex);
                }
            });

            elements.reportHistoryList.addEventListener('click', (e) => {
                const historyItem = e.target.closest('.history-item');
                if (historyItem) {
                    const sessionId = parseInt(historyItem.dataset.sessionId, 10);
                    loadReport(sessionId);
                }
            });

            elements.showAnswerBtn.addEventListener('click', () => {
                showAlert('建议答案', opportunityData.generatedQA[currentQuestionIndex].a);
            });

            // --- New JD Analysis Logic ---
            elements.analyzeJdBtn.addEventListener('click', () => {
                elements.analyzeJdBtn.disabled = true;
                elements.analyzeJdBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AI分析中...';
                elements.jdAnalysisResults.classList.add('hidden');

                setTimeout(() => {
                    // Mock Keywords (replace with actual AI output)
                    const mockKeywords = ['JavaScript', 'React', 'Node.js', '数据结构', '算法', '团队协作', '项目管理'];
                    elements.keywordsList.innerHTML = mockKeywords.map(kw => `<span class="bg-blue-200 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">${kw}</span>`).join('');

                    // Mock User Profile (replace with actual user data from profile.html)
                    const mockUserProfile = {
                        skills: ['JavaScript', 'Java', 'Python', 'Vue.js'],
                        projects: ['电商平台 (React)', '图书管理系统 (Flask)'],
                        experience: ['团队协作', '项目管理']
                    };

                    let preMatchFeedback = '根据您的个人信息，与该岗位JD匹配度较高。特别是**JavaScript**和**React**经验非常吻合。' +
                                            '建议在简历中进一步突出您在**Node.js**和**算法**方面的经验，以提高匹配度.';
                    
                    elements.preMatchText.textContent = preMatchFeedback;

                    elements.jdAnalysisResults.classList.remove('hidden');
                    elements.analyzeJdBtn.disabled = false;
                    elements.analyzeJdBtn.innerHTML = '<i class="fas fa-brain mr-2"></i>AI分析JD';
                }, 2000);
            });
        });
    </script>
</body>
</html>