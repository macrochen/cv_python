<!--pages/opportunity-detail/opportunity-detail.wxml-->
<view class="page-container">
  <!-- Header -->
  <view class="header-section">
    <text class="position-title">{{opportunity.position_name}}</text>
    <text class="company-name">{{opportunity.company_name}}</text>
  </view>

  <!-- Main AI Actions -->
  <view class="actions-container">
    <view class="action-card resume" bindtap="showKeywordModal" disabled="{{isGeneratingResume}}">
      <text class="action-icon">{{isGeneratingResume ? 'â³' : 'âœ¨'}}</text>
      <view class="action-text">
        <text class="action-title">{{isGeneratingResume ? 'AI æ­£åœ¨ç”Ÿæˆä¸­...' : 'AI ç”Ÿæˆå®šåˆ¶ç®€å†'}}</text>
        <text class="action-subtitle">æ ¹æ®JDå’Œä½ çš„èƒŒæ™¯ï¼Œé‡èº«æ‰“é€ </text>
      </view>
    </view>
    <view class="action-card practice">
      <view wx:if="{{generatedQaList.length === 0}}" class="practice-initial-state">
        <button id="main-action-practice" class="action-button" bindtap="handleGeneratePractice"
          disabled="{{isGeneratingQa}}">
          <text class="action-icon">{{isGeneratingQa ? 'â³' : 'ğŸ™ï¸'}}</text>
          <view class="action-text">
            <text class="action-title">{{isGeneratingQa ? 'AI æ­£åœ¨ç”Ÿæˆé—®é¢˜...' : 'AI è¿›è¡Œé¢è¯•æ¼”ç»ƒ'}}</text>
            <text class="action-subtitle">æ¨¡æ‹Ÿå®æˆ˜ï¼Œé¢„æµ‹é—®é¢˜å¹¶ç»ƒä¹ </text>
          </view>
        </button>
      </view>
      <view wx:if="{{generatedQaList.length > 0}}" class="practice-confirm-state">
        <text class="confirm-text">AI å·²ä¸ºæ‚¨ç”Ÿæˆ {{generatedQaList.length}} ä¸ªé«˜é¢‘é—®é¢˜ï¼</text>
        <button class="start-practice-btn" bindtap="startPractice">ç«‹å³å¼€å§‹</button>
      </view>
    </view>
  </view>

  <!-- Secondary Content (Tabs) -->
  <view class="tabs-container">
    <scroll-view scroll-x class="tab-bar">
      <view class="tab-item"
        style="{{activeTab === 'details' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}"
        data-tab="details" bindtap="switchTab">èŒä½è¯¦æƒ…</view>
      <view class="tab-item"
        style="{{activeTab === 'resume' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}"
        data-tab="resume" bindtap="switchTab">ç®€å†è¯¦æƒ…</view>
      <view class="tab-item"
        style="{{activeTab === 'qa' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}"
        data-tab="qa" bindtap="switchTab">é—®ç­”è¯¦æƒ…</view>
      <view class="tab-item"
        style="{{activeTab === 'report' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}"
        data-tab="report" bindtap="switchTab">è¯„ä¼°æŠ¥å‘Š</view>
    </scroll-view>

    <view class="tab-content-container">
      <!-- Position Details Tab -->
      <view class="tab-content" hidden="{{activeTab !== 'details'}}">
        <view class="card">
          <towxml nodes="{{jdMarkdown}}" />

          <!-- AI Analyze JD Button -->
          <button class="analyze-jd-btn" bindtap="handleAnalyzeJd" disabled="{{isAnalyzingJd}}">
            <block wx:if="{{isAnalyzingJd}}">AIåˆ†æä¸­...</block>
            <block wx:else>AIåˆ†æJD</block>
          </button>

          <!-- JD Analysis Results -->
          <view class="jd-analysis-results" wx:if="{{jdAnalysisResult}}">
            <view class="jd-keywords-analysis">
              <text class="analysis-title">æ ¸å¿ƒå…³é”®è¯</text>
              <view class="keywords-list">
                <block wx:for="{{jdAnalysisResult.keywords}}" wx:key="*this">
                  <text class="keyword-tag">{{item}}</text>
                </block>
              </view>
            </view>
            <view class="resume-pre-match-analysis">
              <text class="analysis-title">ç®€å†é¢„åŒ¹é…åˆ†æ</text>
              <text class="pre-match-text">{{jdAnalysisResult.preMatchText}}</text>
            </view>
          </view>

        </view>
      </view>
      <!-- Resume Tab -->
      <view class="tab-content" hidden="{{activeTab !== 'resume'}}">
        <view class="card">
          <block wx:if="{{!generatedResumeMd}}">
            <view class="placeholder-card">
              <text>å°šæœªç”Ÿæˆç®€å†ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹çš„â€œAIç”Ÿæˆå®šåˆ¶ç®€å†â€æŒ‰é’®å¼€å§‹ã€‚</text>
            </view>
          </block>
          <block wx:else>
            <!-- Resume Content -->
            <view class="resume-content-container">
              <!-- Display Mode -->
              <view wx:if="{{!isEditingResume}}">
                <view class="resume-actions">
                  <button class="resume-btn" bindtap="downloadPdf">ä¸‹è½½PDF</button>
                  <button class="resume-btn secondary" bindtap="editResume">ç¼–è¾‘</button>
                </view>
                <view class="resume-preview">
                  <towxml nodes="{{resumeMarkdown}}" />
                </view>
              </view>

              <!-- Edit Mode -->
              <view wx:if="{{isEditingResume}}">
                <textarea class="resume-editor" value="{{editingResumeMd}}" bindinput="handleResumeEditorInput"
                  maxlength="20000"></textarea>
                <view class="resume-actions">
                  <button class="resume-btn secondary" bindtap="cancelEditResume">å–æ¶ˆ</button>
                  <button class="resume-btn" bindtap="saveResume">ä¿å­˜</button>
                </view>
              </view>
            </view>
          </block>
        </view>
      </view>
      <!-- Q&A Tab -->
      <view class="tab-content" hidden="{{activeTab !== 'qa'}}">
        <view class="qa-controls">
          <button class="qa-btn add" bindtap="handleAddQa">+ æ–°å¢é—®é¢˜</button>
          <button class="qa-btn save" bindtap="saveQaList">ä¿å­˜å…¨éƒ¨ä¿®æ”¹</button>
        </view>
        <view wx:if="{{generatedQaList.length === 0}}" class="card placeholder-card">
          <text>å°šæœªç”Ÿæˆé—®ç­”ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹çš„â€œAIè¿›è¡Œé¢è¯•æ¼”ç»ƒâ€æŒ‰é’®å¼€å§‹ã€‚</text>
        </view>
        <view wx:else class="qa-list-container">
          <block wx:for="{{generatedQaList}}" wx:for-item="item" wx:for-index="index" wx:key="index">
            <view class="qa-item">
              <view class="qa-item-header">
                <textarea class="question-input" value="{{item.question_text}}" bindinput="handleQaInputChange"
                  data-index="{{index}}" data-field="question_text" auto-height></textarea>
                <view class="delete-qa-btn" bindtap="deleteQa" data-index="{{index}}">Ã—</view>
              </view> <textarea class="answer-input" value="{{item.suggested_answer}}" bindinput="handleQaInputChange"
                data-index="{{index}}" data-field="suggested_answer" auto-height></textarea>
            </view>
          </block>
        </view>
      </view>
      <view class="tab-content" hidden="{{activeTab !== 'report'}}">
          <view class="weui-cells__group weui-cells__group_form report-section" wx:if="{{historicalInterviewSessions.length > 0}}">
            <view class="weui-cells__title">å†å²é¢è¯•è®°å½•</view>
            <view class="weui-cells weui-cells_form">
                          <view class="weui-cell weui-cell_access historical-session-item {{session.id === activeHistoricalSessionId ? 'active' : ''}}" wx:for="{{historicalInterviewSessions}}" wx:for-item="session"
                            wx:key="id" bindtap="loadHistoricalSession" data-session-id="{{session.id}}">
                            <text class="active-indicator" wx:if="{{session.id === activeHistoricalSessionId}}">â–¶</text>
                            <view class="weui-cell__bd">{{session.formatted_session_date}} - æ€»åˆ†: {{session.overall_score}}</view>                <view class="weui-cell__ft weui-cell__ft_in-access"></view>
              </view>
            </view>
          </view>

          <view class="weui-cells__group weui-cells__group_form report-section" wx:if="{{latestInterviewSession}}">
            <view class="weui-cells weui-cells_form">
              <view class="weui-cell">
                <view class="weui-cell__bd">
                  <view class="weui-label">æ€»åˆ†:</view>
                  <view class="weui-cell__ft score-display">{{latestInterviewSession.overall_score}}</view>
                </view>
              </view>
              <view class="weui-cell summary-cell">
                <view class="weui-cell__bd">
                  <view class="weui-label">æ€»ç»“:</view>
                  <view class="report-summary-content">
                    <towxml nodes="{{reportSummaryRichText}}" />
                  </view>
                </view>
              </view>
              <view class="weui-cell radar-data-cell">
                <view class="weui-cell__bd">
                  <view class="weui-label">èƒ½åŠ›å¾—åˆ†:</view>
                  <view class="radar-chart-container" wx:if="{{latestInterviewSession.radar_chart_data_array && latestInterviewSession.radar_chart_data_array.length > 0}}">
                    <block wx:for="{{latestInterviewSession.radar_chart_data_array}}" wx:for-item="item" wx:key="key">
                      <view class="radar-skill-item">
                        <text class="skill-name">{{item.key}}</text>
                        <view class="skill-bar-background">
                          <view class="skill-bar-fill" style="width: {{item.value}}%;"></view>
                          <text class="skill-score">{{item.value}}</text>
                        </view>
                      </view>
                    </block>
                  </view>
                  <text wx:else class="radar-data-text">æš‚æ— èƒ½åŠ›å¾—åˆ†æ•°æ®ã€‚</text>
                </view>
              </view>
            </view>
          </view>
          <view class="weui-cell" wx:else>
            <view class="weui-cell__bd">
              <view class="weui-label">æš‚æ— é¢è¯•è¯„ä¼°æ•°æ®ã€‚</view>
            </view>
          </view>

          <view class="weui-cells__group weui-cells__group_form report-section" wx:if="{{selectedSessionAnswers.length > 0}}">
            <view class="weui-cells__title">ä¼šè¯è¯¦æƒ…</view>
            <view class="weui-cells weui-cells_form">
              <view class="weui-cell" wx:for="{{selectedSessionAnswers}}" wx:for-item="answer" wx:key="id">
                <view class="weui-cell__bd">
                  <view class="weui-label">é—®é¢˜: {{answer.question_text}}</view>
                  <view class="weui-textarea">ä½ çš„å›ç­”: {{answer.user_answer_transcript || 'æš‚æ— '}}</view>
                  <view class="weui-label">AIåé¦ˆ:</view>
                  <view class="ai-feedback-content">
                    <towxml nodes="{{answer.aiFeedbackRichText}}" />
                  </view>
                </view>
              </view>
            </view>
          </view>
      </view>

      <!-- Practice Overlay -->
      <view wx:if="{{isPracticeOverlayVisible}}" class="practice-overlay">
        <!-- Header -->
        <view class="practice-header">
          <text class="practice-status">é¢è¯•æ¼”ç»ƒä¸­ ({{currentQuestionIndex + 1}}/{{generatedQaList.length}})</text>
          <text class="close-practice-btn" bindtap="closePractice">Ã—</text>
        </view>

        <!-- Main Content -->
        <view class="practice-main-content">
          <text class="practice-question">{{generatedQaList[currentQuestionIndex].question_text}}</text>

          <!-- Text Input State -->
          <view wx:if="{{practiceState === 'initial' || practiceState === 'answering'}}" class="practice-state-answering">
            <textarea class="answer-textarea" placeholder="è¯·è¾“å…¥ä½ çš„å›ç­”..." value="{{userAnswerText}}" bindinput="handleTextInput" auto-height show-confirm-bar="{{false}}" maxlength="2000"></textarea>
            <text class="voice-input-hint">ğŸ’¡ æ‚¨å¯ä»¥ä½¿ç”¨æ‰‹æœºè‡ªå¸¦çš„è¯­éŸ³è¾“å…¥æ³•è¿›è¡Œå›ç­”</text>
            <button class="submit-answer-btn" bindtap="submitTextAnswer" disabled="{{!userAnswerText}}">æäº¤å›ç­”</button>
          </view>
          <!-- Feedback State -->
          <view wx:if="{{practiceState === 'feedback'}}" class="practice-state-feedback">
            <text class="feedback-title">ä½ çš„å›ç­”:</text>
            <text class="user-answer-transcript">{{userAnswerTranscript}}</text>
            <text class="feedback-title">AI åé¦ˆ:</text>
            <text class="ai-feedback-text">{{aiFeedback}}</text>
          </view>
        </view>

        <!-- Footer -->
        <view class="practice-footer">
          <button class="show-answer-btn" bindtap="showSuggestedAnswer">æŸ¥çœ‹å»ºè®®ç­”æ¡ˆ</button>
          <button class="next-question-btn"
            bindtap="nextQuestion">{{currentQuestionIndex === generatedQaList.length - 1 ? 'å®Œæˆé¢è¯•ï¼ŒæŸ¥çœ‹è¯„ä¼°' : 'ä¸‹ä¸€é¢˜ â†’'}}</button>
        </view>
      </view>

    </view>

  </view>
</view>
<!-- Keyword Input Modal -->
<view wx:if="{{isKeywordModalVisible}}" class="modal-backdrop" bindtap="hideKeywordModal">
  <view class="modal-panel keyword-modal" catchtap="doNothing">
    <view class="modal-header">
      <text class="modal-title">å…³é”®è¯å¼•å¯¼</text>
    </view>
    <view class="modal-body">
      <text class="form-label">è¾“å…¥å¸Œæœ›AIé‡ç‚¹çªå‡ºçš„å…³é”®è¯ï¼ˆå¯é€‰ï¼‰</text>
      <input class="form-input" placeholder="ä¾‹å¦‚: Vue3, å›¢é˜Ÿåˆä½œ" value="{{resumeKeywords}}"
        bindinput="handleKeywordInput" />
    </view>
    <view class="modal-footer">
      <button class="modal-button cancel" bindtap="hideKeywordModal">å–æ¶ˆ</button>
      <button class="modal-button save" bindtap="generateResumeWithKeywords">ç¡®è®¤ç”Ÿæˆ</button>
    </view>
  </view>
</view>

