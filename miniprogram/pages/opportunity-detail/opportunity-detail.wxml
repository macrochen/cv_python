<!--pages/opportunity-detail/opportunity-detail.wxml-->
<view class="page-container">
  <!-- Header -->
  <view class="header-section">
    <text class="position-title">{{opportunity.position_name}}</text>
    <text class="company-name">{{opportunity.company_name}}</text>
  </view>

  <!-- Main AI Actions -->
  <view class="actions-container">
    <view class="action-card resume" bindtap="showKeywordModal" disabled="{{isGeneratingResume}}">
      <text class="action-icon">{{isGeneratingResume ? '⏳' : '✨'}}</text>
      <view class="action-text">
        <text class="action-title">{{isGeneratingResume ? 'AI 正在生成中...' : 'AI 生成定制简历'}}</text>
        <text class="action-subtitle">根据JD和你的背景，量身打造</text>
      </view>
    </view>
    <view class="action-card practice">
      <text class="action-icon">🎙️</text>
      <view class="action-text">
        <text class="action-title">AI 进行面试演练</text>
        <text class="action-subtitle">模拟实战，预测问题并练习</text>
      </view>
    </view>
  </view>

  <!-- Secondary Content (Tabs) -->
  <view class="tabs-container">
    <scroll-view scroll-x class="tab-bar">
      <view class="tab-item" style="{{activeTab === 'details' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}" data-tab="details" bindtap="switchTab">职位详情</view>
      <view class="tab-item" style="{{activeTab === 'resume' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}" data-tab="resume" bindtap="switchTab">简历详情</view>
      <view class="tab-item" style="{{activeTab === 'qa' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}" data-tab="qa" bindtap="switchTab">问答详情</view>
      <view class="tab-item" style="{{activeTab === 'report' ? 'color: #3b82f6; font-weight: 600; border-bottom-color: #3b82f6;' : ''}}" data-tab="report" bindtap="switchTab">评估报告</view>
    </scroll-view>

    <view class="tab-content-container">
      <!-- Position Details Tab -->
      <view class="tab-content" hidden="{{activeTab !== 'details'}}">
        <view class="card">
          <towxml nodes="{{jdMarkdown}}"/>

          <!-- AI Analyze JD Button -->
          <button class="analyze-jd-btn" bindtap="handleAnalyzeJd" disabled="{{isAnalyzingJd}}">
            <block wx:if="{{isAnalyzingJd}}">AI分析中...</block>
            <block wx:else>AI分析JD</block>
          </button>

          <!-- JD Analysis Results -->
          <view class="jd-analysis-results" wx:if="{{jdAnalysisResult}}">
            <view class="jd-keywords-analysis">
              <text class="analysis-title">核心关键词</text>
              <view class="keywords-list">
                <block wx:for="{{jdAnalysisResult.keywords}}" wx:key="*this">
                  <text class="keyword-tag">{{item}}</text>
                </block>
              </view>
            </view>
            <view class="resume-pre-match-analysis">
              <text class="analysis-title">简历预匹配分析</text>
              <text class="pre-match-text">{{jdAnalysisResult.preMatchText}}</text>
            </view>
          </view>

        </view>
      </view>
      <!-- Resume Tab -->
      <view class="tab-content" hidden="{{activeTab !== 'resume'}}">
        <view class="card">
          <block wx:if="{{!generatedResumeMd}}">
            <view class="placeholder-card">
              <text>尚未生成简历。请点击上方的“AI生成定制简历”按钮开始。</text>
            </view>
          </block>
          <block wx:else>
            <view class="resume-content-container">
              <view class="resume-actions">
                <button class="resume-btn">下载PDF</button>
                <button class="resume-btn secondary">编辑</button>
              </view>
              <view class="resume-preview">
                <towxml nodes="{{resumeMarkdown}}"/>
              </view>
            </view>
          </block>
        </view>
      </view>
      <view class="tab-content" hidden="{{activeTab !== 'qa'}}">
        <view class="card placeholder-card">
          <text>问答详情功能待开发</text>
        </view>
      </view>
      <view class="tab-content" hidden="{{activeTab !== 'report'}}">
        <view class="card placeholder-card">
          <text>评估报告功能待开发</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Keyword Input Modal -->
  <view wx:if="{{isKeywordModalVisible}}" class="modal-backdrop" bindtap="hideKeywordModal">
    <view class="modal-panel keyword-modal" catchtap="doNothing">
      <view class="modal-header">
        <text class="modal-title">关键词引导</text>
      </view>
      <view class="modal-body">
        <text class="form-label">输入希望AI重点突出的关键词（可选）</text>
        <input class="form-input" placeholder="例如: Vue3, 团队合作" value="{{resumeKeywords}}" bindinput="handleKeywordInput"/>
      </view>
      <view class="modal-footer">
        <button class="modal-button cancel" bindtap="hideKeywordModal">取消</button>
        <button class="modal-button save" bindtap="generateResumeWithKeywords">确认生成</button>
      </view>
    </view>
  </view>

</view>